<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰‘æ¥ï¼</title>
    <link rel="icon" type="image/png" href="swords.png">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

        body { 
            margin: 0;
            overflow: hidden; 
            background-color: #050505;
            color: #39ff14; 
            font-family: 'Courier New', monospace;
        }
        canvas { 
            display: block; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 10; 
            transform: scaleX(-1); /* é•œåƒç¿»è½¬ï¼Œç¬¦åˆé•œå­ä¹ æƒ¯ */ 
        }
        #video-container { display: none; }
        
        .cyber-font { font-family: 'Ma Shan Zheng', cursive; }
        
        .hud-layer { 
            position: absolute; 
            z-index: 20; 
            pointer-events: none; 
            width: 100%; 
            height: 100%;
            background: radial-gradient(circle at center, transparent 50%, #000 130%);
        }
        
        .mode-title {
            text-shadow: 0 0 10px rgba(57, 255, 20, 0.8), 0 0 20px rgba(57, 255, 20, 0.4);
        }

        .loading-screen {
            position: absolute; inset: 0; background: #000; z-index: 50;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>
    <!-- Loading -->
    <div id="loading" class="loading-screen">
        <div class="text-6xl text-green-400 mb-4 cyber-font tracking-widest animate-pulse">å‰‘æ„å‡èšä¸­...</div>
        <div class="mt-8 text-xs text-gray-500 border border-gray-800 p-2">
            è¯·æˆäºˆæ‘„åƒå¤´æƒé™ä»¥æ¥å…¥ç¥è¯† (Camera Access Required)
        </div>
    </div>

    <!-- HUD -->
    <div class="hud-layer">
        <div class="absolute top-6 left-6">
            <h1 class="text-3xl text-green-400 cyber-font tracking-widest">çµæ¸Šå‰‘å¢ƒ</h1>
            <div class="text-xs text-green-700 mt-1 font-mono">
                <span>[â˜ï¸ å¾¡å‰‘ FOLLOW]</span>
                <span>[âœŠ æŠ¤é˜µ SHIELD]</span>
                <span>[ğŸ–ï¸ å‰‘é›¨ RAIN]</span>
                <span>[ğŸ¤Ÿ ä¸‡å‰‘å½’å®— ULTIMATE]</span>
            </div>
        </div>
    
        <!-- Mode Indicator -->
        <div class="absolute bottom-16 w-full text-center">
            <div id="mode-text" class="text-6xl cyber-font text-transparent bg-clip-text bg-gradient-to-t from-green-800 to-yellow-300 mode-title transition-all duration-500">
                æ— æˆ‘å‰‘å¿ƒ
            </div>
            <div id="mode-sub" class="mt-2 text-sm text-green-500 font-mono tracking-[0.5em] opacity-80">
                VOID MIND
            </div>
        </div>
    </div>

    <canvas id="output_canvas"></canvas>
    <audio id="bgm" loop>
        <source src="sword_bgm.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
    </audio>
    <div id="video-container"><video class="input_video"></video></div>

<script>
/**
 * æ ¸å¿ƒé…ç½® (Config)
 */
const CONFIG = {
    particleCount: 400,
    baseFov: 800,        
    colors: {
        core: '#FFFFE0', // å‰‘é”‹æäº®ç™½é»„
        main: '#39FF14', // ä¸»ä½“è§å…‰ç»¿
        gold: '#FFD700', // é‡‘è‰²å‰‘æ°”ï¼ˆæ··æ‚ï¼‰
        glow: '#39FF14'  // è¾‰å…‰é¢œè‰²
    },
    shakeIntensity: 0
};

/**
 * å…¨å±€çŠ¶æ€ (State)
 */
const STATE = {
    mode: 'IDLE', 
    time: 0,
    width: window.innerWidth,
    height: window.innerHeight,
    camera: { x: 0, y: 0, z: 0 },
    rainFreeze: 0,
    trail: [],
    trailMax: 120,
    lastTime: 0,
    lastCursorX: 0,
    lastCursorY: 0,
    cursorSpeed: 0,
    orbitMode: false,
    timeScale: 1,
    // æƒ¯æ€§ç³»ç»Ÿ
    cursor: {
        targetX: 0, targetY: 0,
        currentX: 0, currentY: 0,
        velocityX: 0, velocityY: 0
    },
    hand: {
        detected: false,
        rawX: 0.5, rawY: 0.5, // åŸå§‹å½’ä¸€åŒ–åæ ‡
    }
};

// Canvas Setup
const canvas = document.getElementById('output_canvas');
const ctx = canvas.getContext('2d'); 

/**
 * é£å‰‘ç²’å­ç±» (Sword Particle)
 */
class Sword {
    constructor(index) {
        this.index = index;
        // ç‰©ç†ä½ç½®
        this.pos = { x: 0, y: 0, z: 0 };
        // ç›®æ ‡ä½ç½®
        this.target = { x: 0, y: 0, z: 0 };
        // æ—‹è½¬è§’åº¦ (Euler)
        this.rot = { x: 0, y: 0, z: 0 };
        
        // å›ºæœ‰å±æ€§
        // ä¸€éƒ¨åˆ†å‰‘æ˜¯é‡‘è‰²çš„ï¼Œå¤§éƒ¨åˆ†æ˜¯ç»¿è‰²çš„
        this.isGold = Math.random() < 0.3; 
        this.scaleBase = 0.8 + Math.random() * 0.4;
        this.length = 40; 
        
        // éšæœºåç§»ï¼Œç”¨äºå„ç§æ¨¡å¼ä¸‹çš„å™ªç‚¹
        this.randomOffset = {
            x: Math.random() * 200 - 100,
            y: Math.random() * 200 - 100,
            z: Math.random() * 200 - 100
        };

        // å‰‘é›¨/ä¸‡å‰‘å½’å®—ä¸“ç”¨é€Ÿåº¦
        this.speed = 10 + Math.random() * 30;
    }

    // ç»˜åˆ¶ä¸€æŠŠå…·ä½“çš„å‰‘
    // x, y: å±å¹•åæ ‡ä¸­å¿ƒ
    // scale: ç¼©æ”¾æ¯”ä¾‹
    // rotation: 2D æ—‹è½¬å¼§åº¦ (ç®€åŒ–ç‰ˆï¼Œä»…åšZè½´æ—‹è½¬æŠ•å½±)
    drawShape(ctx, x, y, scale, rotation) {
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rotation);
        ctx.scale(scale, scale);

        // è®¾ç½®å‘å…‰
        ctx.shadowBlur = 10;
        ctx.shadowColor = this.isGold ? CONFIG.colors.gold : CONFIG.colors.glow;
        
        // é¢œè‰²
        const colorMain = this.isGold ? '#FFD700' : '#39FF14';
        const colorCore = '#FFFFFF';

        // === ç»˜åˆ¶å‰‘èº« (Blade) ===
        ctx.beginPath();
        // å‰‘å°– (0, -len)
        ctx.moveTo(0, -this.length);
        // å‰‘èº«æœ€å®½å¤„
        ctx.lineTo(4, 0);
        // å‰‘æŸ„è¿æ¥å¤„
        ctx.lineTo(0, 5);
        // å‰‘èº«å·¦ä¾§
        ctx.lineTo(-4, 0);
        ctx.closePath();
        
        ctx.fillStyle = colorMain;
        ctx.fill();

        // å‰‘è„Š (é«˜å…‰)
        ctx.beginPath();
        ctx.moveTo(0, -this.length);
        ctx.lineTo(0, 5);
        ctx.strokeStyle = colorCore;
        ctx.lineWidth = 1;
        ctx.stroke();

        // === ç»˜åˆ¶æŠ¤æ‰‹ (Guard) ===
        ctx.beginPath();
        // ç®€å•çš„ V å‹æˆ– ä¸€å­—å‹æŠ¤æ‰‹
        ctx.moveTo(-8, 2);
        ctx.lineTo(0, -2);
        ctx.lineTo(8, 2);
        ctx.lineTo(0, 6);
        ctx.closePath();
        ctx.fillStyle = colorMain;
        ctx.fill();

        // === ç»˜åˆ¶å‰‘æŸ„ (Hilt) ===
        ctx.beginPath();
        ctx.moveTo(0, 5);
        ctx.lineTo(0, 15);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#888'; // å‰‘æŸ„ç•¥æš—
        ctx.stroke();

        // å‰‘é¦– (Pommel)
        ctx.beginPath();
        ctx.arc(0, 16, 2, 0, Math.PI*2);
        ctx.fillStyle = colorMain;
        ctx.fill();

        ctx.restore();
    }

    update() {
        const t = STATE.time;
        const count = CONFIG.particleCount;
        const indexNormal = this.index / count; // 0.0 ~ 1.0

        // --- ç›®æ ‡è®¡ç®—é€»è¾‘ ---
        
        if (STATE.mode === 'IDLE') {
            // == å·¨å‰‘æ‚¬æµ® (Giant Sword Construction) ==
            // å°†æ‰€æœ‰ç²’å­æ˜ å°„åˆ°ä¸€ä¸ªå·¨å¤§çš„å‰‘å½¢ä¸Š
            // å‰‘é«˜çº¦ 500, å®½çº¦ 100
            
            // ç®€å•çš„æ˜ å°„é€»è¾‘ï¼šæ ¹æ® index åˆ†é…åˆ° å‰‘å°–ã€å‰‘èº«ã€æŠ¤æ‰‹ã€å‰‘æŸ„
            
            let lx = 0, ly = 0, lz = 0;
            
            // å‘¼å¸æ•ˆæœ
            const breath = Math.sin(t * 1.5) * 10;
            const floatY = Math.sin(t * 0.8) * 20;

            if (indexNormal < 0.15) {
                // å‰‘æŸ„ (Hilt) & å‰‘é¦–: åº•éƒ¨çº¿æ®µ
                const subP = indexNormal / 0.15;
                lx = 0;
                ly = 150 + subP * 80; 
                lz = 0;
            } else if (indexNormal < 0.30) {
                // æŠ¤æ‰‹ (Guard): æ¨ªå‘çº¿æ®µ
                const subP = (indexNormal - 0.15) / 0.15;
                lx = (subP - 0.5) * 120; // å®½æŠ¤æ‰‹
                ly = 150 - Math.abs(lx) * 0.3; // å¾®å¾®ä¸Šç¿˜
                lz = 0;
            } else {
                // å‰‘èº« (Blade): ä¸‰è§’å½¢åˆ†å¸ƒ
                // ä»æŠ¤æ‰‹(150) åˆ° å‰‘å°–(-250)
                const subP = (indexNormal - 0.30) / 0.70; // 0(åº•) -> 1(å°–)
                const bladeWidthAtY = (1 - subP) * 40; // è¶Šå¾€ä¸Šè¶Šçª„
                
                // åœ¨å®½åº¦å†…éšæœºåˆ†å¸ƒï¼Œæˆ–è€…è¾¹ç¼˜åˆ†å¸ƒ
                // è¿™é‡Œåšè¾¹ç¼˜åˆ†å¸ƒï¼Œè½®å»“æ›´æ¸…æ™°
                const side = this.index % 2 === 0 ? 1 : -1;
                lx = side * bladeWidthAtY; 
                
                // å¶å°”å¡«å……ä¸­é—´
                if (this.index % 5 === 0) lx *= Math.random(); 

                ly = 150 - subP * 450; // é•¿åº¦ 450
                lz = 0;
            }

            // èµ‹äºˆç›®æ ‡
            this.target.x = lx;
            this.target.y = ly + floatY;
            this.target.z = lz;

            // æ—‹è½¬ï¼šå¾…æœºæ—¶å‚ç›´ç«–ç«‹ï¼Œç¨å¾®è½¬ä¸€ç‚¹è§’åº¦å±•ç¤º3D
            this.rot.z = 0; // è‡ªèº«ä¸è½¬ï¼Œæˆ–è€…æ˜¯æ•´ä½“è½¬
        }
        else if (STATE.mode === 'FOLLOW') {
            if (STATE.trail.length < 10) return;
            
            // 1ï¸âƒ£ è®©å‰‘æ²¿ç€è½¨è¿¹è‡ªç„¶åˆ†å¸ƒï¼ˆä¸æ˜¯åˆ†ç»„ï¼‰
            const spread = 0.7; 
            const trailIndex = Math.floor(
                (this.index / CONFIG.particleCount) * 
                STATE.trail.length * spread
            );

            const head = STATE.trail[trailIndex];
            const prev = STATE.trail[Math.min(trailIndex + 2, STATE.trail.length - 1)];

            if (!head || !prev) return;

            // 2ï¸âƒ£ è®¡ç®—æ–¹å‘
            let vx = head.x - prev.x;
            let vy = head.y - prev.y;
            let len = Math.sqrt(vx*vx + vy*vy) || 1;

            const tx = vx / len;
            const ty = vy / len;

            // æ³•å‘é‡
            const nx = -ty;
            const ny = tx;

            // 3ï¸âƒ£ æ¨ªå‘éšæœºï¼ˆåƒé©¬æ‹‰æ¾å¹¶æ’ï¼‰
            const lateral = (Math.random() - 0.5) * 80;

            // 4ï¸âƒ£ å‰åå¾®éšæœºï¼ˆé¿å…æ•´é½æ’é˜Ÿï¼‰
            const forwardOffset = (Math.random() - 0.5) * 40;

            this.target.x = head.x + nx * lateral + tx * forwardOffset;
            this.target.y = head.y + ny * lateral + ty * forwardOffset;

            // 5ï¸âƒ£ æ·±åº¦éšè½¨è¿¹é€’å‡ï¼ˆå‰é¢çš„åœ¨å‰ï¼‰
            this.target.z = -trailIndex * 6;

            // æœå‘è¿åŠ¨æ–¹å‘
            this.rot.z = Math.atan2(ty, tx) + Math.PI / 2;
        } 
        else if (STATE.mode === 'ULTIMATE') {
            const total = CONFIG.particleCount;
            const ringCount = 5;          // äº”å±‚å‰‘é˜µ
            const ringIndex = this.index % ringCount;
            const layer = Math.floor(this.index / ringCount);

            const baseRadius = 250 + ringIndex * 120;
            const angle = (layer / (total / ringCount)) * Math.PI * 2 + STATE.time * 0.3;

            const targetX = Math.cos(angle) * baseRadius;
            const targetY = Math.sin(angle) * baseRadius;

            // ===== ç¬¬ä¸€é˜¶æ®µï¼šæ‚¬æµ®èšé˜µ =====
            if (STATE.phase < 3) {

                this.pos.x += (targetX - this.pos.x) * 0.08;
                this.pos.y += (targetY - this.pos.y) * 0.08;

                // è½»å¾®ä¸Šä¸‹æµ®åŠ¨
                this.pos.y += Math.sin(STATE.time * 3 + this.index) * 1.5;

                this.pos.z = 600 + Math.sin(this.index) * 50;

            }

            // ===== ç¬¬äºŒé˜¶æ®µï¼šç¥ç½šé™ä¸´ =====
            else {

                this.pos.z -= 40 + ringIndex * 5;

                if (this.pos.z < -1000) {
                    this.pos.z = 800;
                }
            }

            // å‰‘å°–æœä¸‹ï¼ˆå‹åˆ¶ï¼‰
            this.rot.z = Math.PI;
        }
        else if (STATE.mode === 'SHIELD') {
            // == æŠ¤ä½“ (Shield) ==
            const phi = Math.PI * (3 - Math.sqrt(5));
            const y = 1 - (this.index / (count - 1)) * 2;
            const radiusAtY = Math.sqrt(1 - y * y);

            // ğŸ”¥ åŠ æ•´ä½“è‡ªæ—‹ï¼ˆYè½´ + Xè½´å¤åˆï¼‰
            const spinSpeed = 0.6;
            const theta = phi * this.index + t * spinSpeed;

            // ğŸ”¥ æŠ¤é˜µåŠå¾„åŠ å¤§ï¼ˆåŸæ¥ 250ï¼‰
            const r = 380;   // â† ä½ å¯ä»¥æ”¹ 350~450 ä¹‹é—´

            const cx = STATE.cursor.currentX;
            const cy = STATE.cursor.currentY;

            const x = Math.cos(theta) * radiusAtY * r;
            const yPos = y * r;
            const z = Math.sin(theta) * radiusAtY * r;

            this.target.x = cx + x;
            this.target.y = cy + yPos;
            this.target.z = z;

            // ğŸ”¥ å‰‘å°–æœå¤–
            this.rot.z = Math.atan2(yPos, x) + Math.PI / 2;
        }
        else if (STATE.mode === 'RAIN') {
             // == å‰‘é›¨ (Rain) ==
            // ===== å®šæ ¼é˜¶æ®µ =====
            if (STATE.rainFreeze > 0) {
                this.rot.z = Math.PI; // æœä¸‹
                return; // å®Œå…¨ä¸åŠ¨
            }

            // ===== åŒæ—¶æš´é›¨ =====
            this.target.y += this.speed;

            if (this.target.y > STATE.height/2 + 150) {
                this.target.y = -STATE.height/2 - 300;
                this.target.x = (Math.random() - 0.5) * STATE.width * 1.2;
                this.target.z = (Math.random() - 0.5) * 600;
            }

            this.pos.y = this.target.y;
            this.pos.x = this.target.x;
            this.pos.z = this.target.z;

            this.rot.z = Math.PI;
        }

        // --- ç‰©ç†æ›´æ–° (Lerp) ---
        // åªæœ‰éç²’å­æµæ¨¡å¼æ‰ä½¿ç”¨ Lerp
        if (STATE.mode !== 'ULTIMATE' && STATE.mode !== 'RAIN') {
            let lerp = 0.1;
            if (STATE.mode === 'IDLE') lerp = 0.10; // èšåˆ
            if (STATE.mode === 'SHIELD') lerp = 0.18;
            
            this.pos.x += (this.target.x - this.pos.x) * lerp;
            this.pos.y += (this.target.y - this.pos.y) * lerp;
            this.pos.z += (this.target.z - this.pos.z) * lerp;
        }
    }

    draw(ctx) {
        // --- 3D æŠ•å½± ---
        const fov = CONFIG.baseFov;
        // éœ‡åŠ¨
        const shakeX = (Math.random()-0.5) * CONFIG.shakeIntensity;
        const shakeY = (Math.random()-0.5) * CONFIG.shakeIntensity;

        // é€è§†é™¤æ³•
        // z è¶Šå¤§è¶Šè¿œ (scale è¶Šå°)
        // å‡è®¾ camera åœ¨ z=0, ç‰©ä½“åœ¨ z
        // è¿™é‡Œ camera.z æ˜¯åç§»é‡
        const scale = fov / (fov + this.pos.z + STATE.camera.z);
        
        if (scale < 0.1) return; // å¤ªè¿‘æˆ–åœ¨èƒŒå

        const x2d = this.pos.x * scale + STATE.width/2 + shakeX;
        const y2d = this.pos.y * scale + STATE.height/2 + shakeY;

        // ç»˜åˆ¶å½¢çŠ¶
        // æ—‹è½¬å¤„ç†ï¼š
        // å¦‚æœæ˜¯ IDLE æ¨¡å¼ï¼Œåšä¸€ç‚¹è‡ªæ—‹è®©å·¨å‰‘çœ‹èµ·æ¥ç«‹ä½“
        let r = this.rot.z;
        if (STATE.mode === 'IDLE') {
             // æ•´ä½“ç¼“æ…¢æ—‹è½¬å·¨å‰‘
             // è¿™é‡Œç®€å•å¤„ç†ï¼šæ ¹æ® z åæ ‡å¾®è°ƒ x ä½ç½®æ²¡æ³•ç›´æ¥åš 3D æ—‹è½¬
             // ä»…åšç®€å•çš„è§†è§‰ä¿®æ­£
             r = 0; 
        }

        this.drawShape(ctx, x2d, y2d, scale * this.scaleBase, r);
    }
}

// åˆå§‹åŒ–
const swords = Array.from({length: CONFIG.particleCount}, (_, i) => new Sword(i));

const stars = Array.from({length: 300}, () => ({
    x: (Math.random() - 0.5) * window.innerWidth,
    y: (Math.random() - 0.5) * window.innerHeight,
    z: Math.random() * 800,
    size: Math.random() * 2 + 0.5
}));

function drawStars() {
    const fov = CONFIG.baseFov;

    stars.forEach(star => {
        // æ˜Ÿæ˜Ÿç¼“æ…¢å‘å‰ç§»åŠ¨ï¼ˆè¥é€ ç©ºé—´æ„Ÿï¼‰
        star.z -= 0.5;

        if (star.z < 1) {
            star.z = 800;
            star.x = (Math.random() - 0.5) * STATE.width;
            star.y = (Math.random() - 0.5) * STATE.height;
        }

        const scale = fov / (fov + star.z);
        const x2d = star.x * scale + STATE.width / 2;
        const y2d = star.y * scale + STATE.height / 2;
        const size = star.size * scale;

        ctx.beginPath();
        ctx.arc(x2d, y2d, size, 0, Math.PI * 2);
        ctx.fillStyle = "white";
        ctx.fill();
    });
}

// ä¸»å¾ªç¯
function animate(t) {
    if (!STATE.lastTime) STATE.lastTime = t;

    const delta = (t - STATE.lastTime) * 0.001;
    STATE.lastTime = t;

    STATE.time += delta * STATE.timeScale;

    if (STATE.rainFreeze > 0) {
    STATE.rainFreeze -= 0.016; // çº¦60fps
    }
    
    // æ›´æ–°æƒ¯æ€§å…‰æ ‡ (Physics Cursor)
    updatePhysicsCursor();
    

    // æ¸…å± (ä¿æŒé»‘è‰²èƒŒæ™¯)
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    // é‡æ–°å¡«å……èƒŒæ™¯ï¼Œé˜²æ­¢ shadowBlur å åŠ è¿‡äº®
    ctx.fillStyle = "#050505";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // ç»˜åˆ¶èƒŒæ™¯æ˜Ÿç©º
    drawStars();

    // é•œå¤´åŠ¨æ€
    let targetZ = 0;
    let targetShake = 0;
    
    if (STATE.mode === 'SHIELD') targetZ = 100;
    if (STATE.mode === 'ULTIMATE') {
        targetZ = -100; 
        targetShake = 5;
    }
    // IDLE æ—¶æ‹‰è¿œä¸€ç‚¹çœ‹å·¨å‰‘
    if (STATE.mode === 'IDLE') targetZ = 200;

    STATE.camera.z += (targetZ - STATE.camera.z) * 0.05;
    CONFIG.shakeIntensity = targetShake;

    // æ’åºï¼šZè½´æ·±åº¦æ’åºï¼Œä¿è¯é®æŒ¡å…³ç³»æ­£ç¡® (Painter's Algorithm)
    // è¿œçš„å…ˆç”»
    swords.sort((a, b) => b.pos.z - a.pos.z);
    
    swords.forEach(s => {
        s.update();
        s.draw(ctx);
    });

    requestAnimationFrame(animate);
}

// ç‰©ç†å…‰æ ‡é€»è¾‘
function updatePhysicsCursor() {
    // ç›®æ ‡ä½ç½®ï¼šå¦‚æœæœ‰æ‰‹ï¼Œå°±æ˜¯æ‰‹çš„ä½ç½®ï¼›æ²¡æ‰‹ï¼Œå°±æ˜¯å±å¹•ä¸­å¿ƒæˆ–æ¼«æ¸¸
    let tx = 0;
    let ty = 0;

    if (STATE.hand.detected) {
        // æ˜ å°„åˆ°ä»¥ä¸­å¿ƒä¸ºåŸç‚¹çš„åæ ‡ç³»
        tx = (STATE.hand.rawX - 0.5) * STATE.width; 
        ty = (STATE.hand.rawY - 0.5) * STATE.height;
        // å¢åŠ ä¸€ç‚¹çµæ•åº¦å€ç‡
        tx *= 1.5;
        ty *= 1.5;
    } else {
        // æ²¡æ‰‹æ—¶çš„è‡ªåŠ¨æ¼«æ¸¸
        if (STATE.mode === 'FOLLOW') {
            tx = Math.sin(STATE.time) * 300;
            ty = Math.cos(STATE.time * 0.8) * 150;
        }
    }

    // å¼¹ç°§é˜»å°¼ (Spring Damper)
    const spring = 0.05; // å¼¹æ€§ç³»æ•°
    const friction = 0.85; // æ‘©æ“¦åŠ›

    // åŠ é€Ÿåº¦
    const ax = (tx - STATE.cursor.currentX) * spring;
    const ay = (ty - STATE.cursor.currentY) * spring;

    // é€Ÿåº¦æ›´æ–°
    STATE.cursor.velocityX += ax;
    STATE.cursor.velocityY += ay;
    STATE.cursor.velocityX *= friction;
    STATE.cursor.velocityY *= friction;

    // ä½ç½®æ›´æ–°
    STATE.cursor.currentX += STATE.cursor.velocityX;
    STATE.cursor.currentY += STATE.cursor.velocityY;

    // è®°å½•è½¨è¿¹å†å²
    STATE.trail.unshift({
        x: STATE.cursor.currentX,
        y: STATE.cursor.currentY
    });

    if (STATE.trail.length > STATE.trailMax) {
        STATE.trail.pop();
    }
    const dx = STATE.cursor.currentX - STATE.lastCursorX;
    const dy = STATE.cursor.currentY - STATE.lastCursorY;

    STATE.cursorSpeed = Math.sqrt(dx*dx + dy*dy);

    STATE.lastCursorX = STATE.cursor.currentX;
    STATE.lastCursorY = STATE.cursor.currentY;

    // åˆ¤æ–­æ˜¯å¦è¿›å…¥ç»•åœˆ
    STATE.orbitMode = STATE.cursorSpeed < 1.5;

}

// MediaPipe Setup
const videoEl = document.getElementsByClassName('input_video')[0];
const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});

hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6
});

hands.onResults(res => {
    if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
        STATE.hand.detected = true;
        const lm = res.multiHandLandmarks[0];
        const palm = lm[9]; // ä¸­æŒ‡æ ¹éƒ¨ä½œä¸ºæ‰‹æŒä¸­å¿ƒ
        
        // åŸå§‹åæ ‡ç›´æ¥å­˜ï¼Œç‰©ç†å…‰æ ‡ä¼šå¤„ç†å¹³æ»‘
        STATE.hand.rawX = palm.x;
        STATE.hand.rawY = palm.y;
        
        detectGesture(lm);
    } else {
        STATE.hand.detected = false;
        if (STATE.mode !== 'IDLE' && STATE.time > 2) updateMode('IDLE');
    }
});

const camera = new Camera(videoEl, {
    onFrame: async () => await hands.send({image: videoEl}),
    width: 640, height: 480
});

function detectGesture(lm) {
    const isUp = (tip, pip) => lm[tip].y < lm[pip].y; 
    const idx = isUp(8, 6);
    const mid = isUp(12, 10);
    const ring = isUp(16, 14);
    const pinky = isUp(20, 18);
    // æ‹‡æŒ‡åˆ¤æ–­ç•¥å¤æ‚ï¼Œç®€åŒ–ä¸ºåˆ¤æ–­xè·ç¦»
    const thumbOut = Math.abs(lm[4].x - lm[9].x) > 0.05;

    let m = STATE.mode; // é»˜è®¤ä¿æŒ
    
    // é€»è¾‘åˆ¤å®š
    if (idx && pinky && !mid && !ring && thumbOut) m = 'ULTIMATE'; // ğŸ¤Ÿ
    else if (idx && mid && ring && pinky) m = 'RAIN'; // ğŸ–ï¸
    else if (!idx && !mid && !ring && !pinky) m = 'SHIELD'; // âœŠ
    else if (idx && !mid && !ring && !pinky) m = 'FOLLOW'; // â˜ï¸
    else if (idx && mid && !ring && !pinky) m = 'FOLLOW'; // âœŒï¸ ä¹Ÿå¯ä»¥ç®—å¾¡å‰‘

    // çŠ¶æ€é˜²æŠ– (ç®€å•çš„)
    if (m !== STATE.mode) updateMode(m);
}

function updateMode(mode) {
    STATE.timeScale = 1;
    STATE.mode = mode;

    // ===== è¿›å…¥å‰‘é›¨æ—¶å¼ºåˆ¶é‡ç½® =====
    if (mode === 'RAIN') {

        STATE.rainFreeze = 0.2; // â­ 0.2ç§’å®šæ ¼

        swords.forEach(s => {

            // å…¨éƒ¨ç¬ç§»åˆ°å¤©ç©º
            s.target.x = (Math.random() - 0.5) * STATE.width * 1.2;
            s.target.y = -STATE.height/2 - 400 - Math.random() * 400;
            s.target.z = (Math.random() - 0.5) * 600;

            // ç›´æ¥åŒæ­¥ä½ç½®ï¼ˆé˜²æ­¢ç»§æ‰¿æŠ¤é˜µï¼‰
            s.pos.x = s.target.x;
            s.pos.y = s.target.y;
            s.pos.z = s.target.z;

            s.speed = 20 + Math.random() * 20;
        });
    }

    if (mode === 'ULTIMATE') {
        STATE.timeScale = 0.2;

        setTimeout(() => {
            STATE.timeScale = 1.6;
        }, 600);

        setTimeout(() => {
            STATE.timeScale = 1;
        }, 1200);

        swords.forEach(s => {

            s.pos.z = 1000 + Math.random() * 1200;

            s.pos.x = (Math.random() - 0.5) * STATE.width * 2;
            s.pos.y = (Math.random() - 0.5) * STATE.height * 2;

            s.speed = 35 + Math.random() * 35;
        });
    }


    const txt = document.getElementById('mode-text');
    const sub = document.getElementById('mode-sub');
    
    const map = {
        'IDLE': ['æ— æˆ‘å‰‘å¿ƒ', 'VOID MIND'],
        'FOLLOW': ['å¾¡å‰‘éšè¡Œ', 'SWORD FOLLOW'],
        'SHIELD': ['å¤©ç½¡å‰‘é˜µ', 'CELESTIAL GUARD'],
        'RAIN': ['å‰‘é›¨æ˜Ÿæ²³', 'SWORDS RAIN'],
        'ULTIMATE': ['ä¸‡å‰‘å½’å®—', 'INFINITE SWORDS']
    };
    
    txt.innerText = map[mode][0];
    sub.innerText = map[mode][1];
    
    // UI åŠ¨ç”»é‡ç½®
    txt.classList.remove('scale-150', 'text-red-500');
    void txt.offsetWidth; 
    
    
    if (mode === 'ULTIMATE') {
        txt.className = "text-6xl cyber-font text-transparent bg-clip-text bg-gradient-to-t from-green-800 to-yellow-300 mode-title transition-all duration-500";
    } else {
        txt.className = "text-6xl cyber-font text-transparent bg-clip-text bg-gradient-to-t from-green-800 to-yellow-300 mode-title transition-all duration-500";
    }

    // æ¨¡å¼åˆ‡æ¢æ—¶çš„ç²’å­é‡ç½®é€»è¾‘ï¼ˆå¯é€‰ï¼‰
    // å¦‚æœæ˜¯ä» ULTIMATE åˆ‡å‡ºï¼Œé‡ç½®ä½ç½®ä»¥é˜²æ•£å¤ªè¿œ
    if (mode === 'IDLE') {
        swords.forEach(s => {
            s.target.x = 0; s.target.y = 0; s.target.z = 0;
        });
    }
}

// å¯åŠ¨
const loadScreen = document.getElementById('loading');
// BGM å…ƒç´ 
const bgm = document.getElementById('bgm');

// æ’­æ”¾å‡½æ•°ï¼ˆæ¸å…¥æ•ˆæœï¼Œå¯é€‰ï¼‰
function startBGM() {
    bgm.volume = 0;
    bgm.play().catch(()=>{ console.log("éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾BGM"); });
    
    // æ¸å…¥æ•ˆæœ
    const step = 0.02;
    const fade = setInterval(() => {
        if(bgm.volume < 1){
            bgm.volume = Math.min(bgm.volume + step, 1);
        } else {
            clearInterval(fade);
        }
    }, 100); // æ¯100mså¢åŠ 
}

// åœ¨æ‘„åƒå¤´æˆæƒåå°è¯•æ’­æ”¾ BGM
camera.start().then(() => {
    // ç§»é™¤ loading
    loadScreen.style.opacity = 0;
    setTimeout(() => loadScreen.style.display = 'none', 1000);

    // æ’­æ”¾ BGM
    startBGM();

    // canvas å°ºå¯¸
    window.onresize = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        STATE.width = canvas.width;
        STATE.height = canvas.height;
    };
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    requestAnimationFrame(animate);
});

// é¢å¤–å¤‡ä»½ï¼šç”¨æˆ·è§¦ç¢°é¡µé¢ä¹Ÿèƒ½æ’­æ”¾
document.body.addEventListener('click', startBGM, { once: true });
document.body.addEventListener('touchstart', startBGM, { once: true });

camera.start().then(() => {
    loadScreen.style.opacity = 0;
    setTimeout(() => loadScreen.style.display = 'none', 1000);
    
    window.onresize = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        STATE.width = canvas.width;
        STATE.height = canvas.height;
    };
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    requestAnimationFrame(animate);
});

</script>
</body>
</html>